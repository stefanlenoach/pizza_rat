import React, { useEffect, useRef } from 'react';
import { View, Animated, Image } from 'react-native';
import { SvgXml } from 'react-native-svg';
import tw from '@/utils/tw';

interface PizzaMarkerProps {
  size?: number;
  color?: string;
  backgroundColor?: string;
  animated?: boolean;
  rating?: number | null;
}

const PizzaMarker: React.FC<PizzaMarkerProps> = ({
  size = 30,
  color = '#FF6B6B',
  backgroundColor = '#222',
  animated = false,
  rating,
}) => {
  // Animation values
  const scaleAnim = useRef(new Animated.Value(0)).current;
  const opacityAnim = useRef(new Animated.Value(0)).current;
  
  // Run animation when marker is mounted
  useEffect(() => {
    if (animated) {
      // Start with small scale and fade in
      Animated.parallel([
        Animated.spring(scaleAnim, {
          toValue: 1,
          friction: 5,
          tension: 300,
          useNativeDriver: true
        }),
        Animated.timing(opacityAnim, {
          toValue: 1,
          duration: 300,
          useNativeDriver: true
        })
      ]).start();
    } else {
      // If not animated, just set to full scale and opacity
      scaleAnim.setValue(1);
      opacityAnim.setValue(1);
    }
  }, []);

  const renderImageBasedOnRating = (rating: number) => {
    const pizzaImages = {
      0: require('@/assets/images/pizza-markers/0.png'),
      1: require('@/assets/images/pizza-markers/1.png'),
      2: require('@/assets/images/pizza-markers/2.png'),
      3: require('@/assets/images/pizza-markers/3.png'),
      4: require('@/assets/images/pizza-markers/4.png'),
      5: require('@/assets/images/pizza-markers/5.png'),
      6: require('@/assets/images/pizza-markers/6.png'),
      7: require('@/assets/images/pizza-markers/7.png'),
      8: require('@/assets/images/pizza-markers/8.png'),
      9: require('@/assets/images/pizza-markers/9.png'),
      10: require('@/assets/images/pizza-markers/10.png'),
    } as any;

    const actualSize = size * 0.7;
    const source = pizzaImages[rating] ?? pizzaImages[0];

    if (!rating) {
      return (
        <SvgXml 
          xml={svgContent}
          width={size * 0.7} 
          height={size * 0.7}
        />
      );
    }

    return (
      <Image
        source={source} 
        style={tw`w-[${actualSize}px] h-[${actualSize}px] rounded-full`}
      />
    );
  };
  
  // Import the SVG content directly
  const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512" xml:space="preserve"><path style="fill:#bc8544" d="M504.5 236.213v35.631c0 12.51-7.923 23.663-19.779 27.843l-385.83 136.04a29.85 29.85 0 0 1-9.926 1.698c-9.131 0-17.667-4.145-23.22-11.075-1.264-1.578-19.041-30.26-21.27-34.71C20.812 344.397 7.5 291.126 7.5 234.762c0-1.935.019-3.865.05-5.792h21.901A334.933 334.933 0 0 1 62.443 119.7c4.998-9.979 15.31-16.225 26.52-16.225h.062c3.342 0 6.659.561 9.813 1.658L454.621 228.97h49.774c.068.828.105 1.663.105 2.504v4.739z"/><path style="fill:#fbb03b" d="M504.5 231.474v4.739c0 13.018-8.245 24.625-20.583 28.975l-29.894 10.54v30.47c0 10.663-8.692 19.307-19.414 19.307s-19.414-8.644-19.414-19.307v-16.78l-106.777 37.649v104.626c0 10.663-8.692 19.307-19.414 19.307s-19.414-8.644-19.414-19.307v-31.564a19.385 19.385 0 0 1-9.707 2.604c-10.722 0-19.414-8.644-19.414-19.307v-32.401l-126.455 44.587-31.612 9.195a31.057 31.057 0 0 1-10.33 1.767c-11.665 0-22.397-4.549-27.598-14.934C20.812 344.397 7.5 291.126 7.5 234.762S20.812 125.128 44.474 77.885C49.675 67.501 60.407 61 72.072 61h.064c3.477 0 6.93.583 10.212 1.726l401.451 139.732c12.399 4.316 20.701 15.953 20.701 29.016z"/><path style="fill:#f99a1e" d="M501.522 218.351a30.52 30.52 0 0 1 2.978 13.123v4.739c0 13.018-8.245 24.625-20.583 28.975l-29.894 10.54v30.47c0 10.663-8.692 19.307-19.414 19.307s-19.414-8.644-19.414-19.307v-16.78l-106.777 37.649v104.626c0 10.663-8.692 19.307-19.414 19.307s-19.414-8.644-19.414-19.307v-31.564a19.385 19.385 0 0 1-9.707 2.604c-10.722 0-19.414-8.644-19.414-19.307v-32.401L114.24 395.532l-31.838 9.274a31.083 31.083 0 0 1-10.33 1.767c-11.665 0-22.397-4.549-27.598-14.934C20.812 344.397 7.5 291.126 7.5 234.762c0-5.501.131-10.971.382-16.411 2.319 50.293 15.24 97.834 36.593 140.467 5.201 10.384 15.933 16.885 27.598 16.885h.064c3.477 0 6.93-.584 10.212-1.726L483.8 234.245a30.826 30.826 0 0 0 17.722-15.894z"/><path style="fill:#d59a4c" d="m90.683 403.838-8.28 2.92a31.057 31.057 0 0 1-10.33 1.767c-11.665 0-22.397-6.501-27.598-16.885C20.812 344.397 7.5 291.126 7.5 234.762S20.812 125.128 44.474 77.885C49.675 67.501 60.407 61 72.072 61h.064c3.477 0 6.93.583 10.212 1.726l31.886 11.099c.019.551.042 1.1.042 1.656 0 24.198-17.907 44.235-41.26 47.726 7.55 8.508 12.139 19.676 12.139 31.915 0 16.535-8.365 31.122-21.111 39.821 12.746 8.698 21.111 23.286 21.111 39.821s-8.365 31.122-21.111 39.821c12.746 8.698 21.111 23.286 21.111 39.821 0 12.239-4.59 23.407-12.139 31.915 23.354 3.491 41.26 23.528 41.26 47.726.001.496-23.593 9.791-23.593 9.791z"/><path style="fill:#bc8544" d="M114.277 394.045c0 .499-.023.992-.038 1.488l-23.557 8.306c-5.11-16.322-17.48-29.462-33.357-35.671-5.402-2.112-7.665-8.585-4.878-13.691a55.75 55.75 0 0 0 6.823-26.8c0-15.417-6.233-29.382-16.327-39.55a9.796 9.796 0 0 1 0-13.815c10.094-10.167 16.327-24.133 16.327-39.55s-6.233-29.382-16.327-39.55a9.796 9.796 0 0 1 0-13.815c10.094-10.167 16.327-24.133 16.327-39.55a55.75 55.75 0 0 0-6.823-26.8c-2.787-5.105-.525-11.578 4.876-13.69C73.22 95.143 85.6 81.981 90.7 65.633l23.536 8.192c.019.551.042 1.1.042 1.656 0 24.198-17.907 44.235-41.26 47.726 7.55 8.508 12.139 19.676 12.139 31.915 0 16.535-8.365 31.122-21.111 39.821 12.746 8.698 21.111 23.286 21.111 39.821s-8.365 31.122-21.111 39.821c12.746 8.698 21.111 23.286 21.111 39.821 0 12.239-4.59 23.407-12.139 31.915 23.353 3.489 41.259 23.525 41.259 47.724z"/><path style="fill:#f24f43" d="M279.267 131.267c.007.39.03.777.03 1.169 0 37.32-30.422 67.574-67.949 67.574s-67.949-30.254-67.949-67.574c0-16.355 5.844-31.353 15.567-43.042l120.301 41.873zm72.833 88.05c-34.847 0-63.096 28.093-63.096 62.748 0 17.693 7.375 33.664 19.22 45.071l106.504-37.552c.296-2.467.467-4.972.467-7.519 0-34.655-28.249-62.748-63.095-62.748z"/><path style="fill:#ed322e" d="m291.942 301.024 119.065-41.443a62.27 62.27 0 0 1 4.189 22.483c0 2.546-.17 5.052-.467 7.519l-106.504 37.552c-7.421-7.145-13.085-16.082-16.283-26.111z"/><path style="fill:#8eb55e" d="M162.813 325.505c-21.444 0-38.828-17.288-38.828-38.614 0-21.326 17.384-38.614 38.828-38.614s38.828 17.288 38.828 38.614c0 21.326-17.384 38.614-38.828 38.614z"/><path d="m185.673 156.08.971-.966a7.5 7.5 0 1 1 10.58 10.632l-.971.966a7.477 7.477 0 0 1-5.29 2.184 7.474 7.474 0 0 1-5.316-2.21 7.5 7.5 0 0 1 .026-10.606zM371.08 270.953l-.971.965a7.5 7.5 0 0 0 5.287 12.819 7.477 7.477 0 0 0 5.287-2.181l.971-.965a7.5 7.5 0 1 0-10.574-10.638zM229.791 159.242a7.477 7.477 0 0 0 5.287-2.181l.971-.965a7.5 7.5 0 0 0 .032-10.606 7.5 7.5 0 0 0-10.606-.032l-.971.965a7.5 7.5 0 0 0-.032 10.606 7.473 7.473 0 0 0 5.319 2.213zm84.015 103.026-.971.966a7.5 7.5 0 1 0 10.58 10.632l.971-.966a7.5 7.5 0 0 0 .026-10.606 7.498 7.498 0 0 0-10.606-.026zM176.888 135.592a7.477 7.477 0 0 0 5.29-2.184l.971-.966a7.5 7.5 0 1 0-10.58-10.632l-.971.966a7.5 7.5 0 0 0 5.29 12.816zm59.264 135.361-.971.965a7.5 7.5 0 0 0 5.287 12.819 7.477 7.477 0 0 0 5.287-2.181l.971-.965a7.5 7.5 0 1 0-10.574-10.638zM512 231.475v40.369c0 15.657-9.96 29.689-24.785 34.917l-27.782 9.796c-4.076 9.652-13.668 16.448-24.824 16.448-4.608 0-8.951-1.16-12.748-3.202l-105.944 37.355v64.535c0 14.781-12.074 26.807-26.914 26.807s-26.914-12.025-26.914-26.807V410.14a26.18 26.18 0 0 1-2.207.092c-14.84 0-26.914-12.025-26.914-26.807v-21.804l-116.075 40.927a6.22 6.22 0 0 1-.324.114L84.896 413.83a38.499 38.499 0 0 1-12.824 2.193 39.44 39.44 0 0 1-4.213-.224c1.896 3.02 3.327 5.26 3.82 5.962 4.148 5.112 10.6 8.162 17.284 8.162 2.54 0 5.04-.428 7.433-1.271l113.629-40.064a7.5 7.5 0 1 1 4.988 14.146L101.385 442.8a37.258 37.258 0 0 1-12.42 2.125c-11.406 0-22.002-5.062-29.073-13.886-1.755-2.192-15.404-24.336-20.454-33.048a38.138 38.138 0 0 1-1.653-2.961l-.016-.032a.226.226 0 0 0-.011-.022C12.702 344.944 0 291.044 0 234.763c0-56.289 12.707-110.2 37.768-160.236C44.265 61.557 57.409 53.5 72.072 53.5c4.393 0 8.658.721 12.742 2.143l31.716 11.039c.114.037.226.076.337.117l44.398 15.454c.111.036.222.074.332.115l119.97 41.758c.11.036.219.074.328.114l73.951 25.74a7.5 7.5 0 0 1-4.93 14.166l-64.683-22.514c-4.571 37.074-36.412 65.877-74.886 65.877-41.603 0-75.449-33.678-75.449-75.074 0-13.896 3.903-27.509 11.136-39.254l-25.948-9.031c-3.174 19.767-16.997 36.517-35.68 43.544a55.483 55.483 0 0 1 7.25 27.427c0 15.111-6.152 29.418-16.813 39.82 10.661 10.403 16.813 24.711 16.813 39.821 0 18.395-9.115 35.596-24.383 46.016a7.5 7.5 0 0 1-8.455-12.391c11.17-7.622 17.838-20.192 17.838-33.625s-6.668-26.003-17.839-33.627a7.5 7.5 0 0 1 0-12.389c11.17-7.622 17.838-20.192 17.838-33.625 0-9.922-3.64-19.489-10.249-26.938a7.5 7.5 0 0 1 4.501-12.395c18.666-2.79 33.021-18.237 34.704-36.676l-26.729-9.304a23.52 23.52 0 0 0-7.747-1.309c-8.878 0-17.079 5.002-20.957 12.744C27.173 129.176 15 180.827 15 234.763c0 53.929 12.169 105.572 36.17 153.499a31.042 31.042 0 0 0 .664 1.231c4.097 7.048 11.892 11.532 20.238 11.532 2.677 0 5.314-.451 7.837-1.34l26.689-9.411c-1.743-18.377-16.073-33.754-34.691-36.537a7.5 7.5 0 0 1-4.501-12.395 40.562 40.562 0 0 0 10.249-26.938c0-4.478-.725-8.874-2.153-13.067a7.502 7.502 0 0 1 4.681-9.519 7.503 7.503 0 0 1 9.518 4.681 55.418 55.418 0 0 1 2.954 17.905 55.493 55.493 0 0 1-7.25 27.427c18.621 7.004 32.414 23.666 35.648 43.347l116.92-41.225a7.498 7.498 0 0 1 9.994 7.073v32.4c0 6.51 5.345 11.807 11.914 11.807 2.111 0 4.118-.539 5.963-1.603a7.503 7.503 0 0 1 11.244 6.499v31.564c0 6.51 5.345 11.807 11.914 11.807s11.914-5.297 11.914-11.807V330.428c-12.542-13.11-19.414-30.17-19.414-48.363 0-38.735 31.669-70.248 70.596-70.248s70.596 31.513 70.596 70.248c0 .729.025 1.455.048 2.178.052 1.61.11 3.405-.048 5.309v16.647c0 6.51 5.345 11.807 11.914 11.807s11.914-5.297 11.914-11.807v-30.47a7.498 7.498 0 0 1 5.006-7.073l29.894-10.541C490.74 254.829 497 246.028 497 236.213v-4.738c0-9.857-6.296-18.672-15.666-21.934l-103.593-36.058a7.5 7.5 0 0 1 4.93-14.166l103.593 36.058c15.394 5.357 25.736 19.865 25.736 36.1zm-361.102-99.039c0 33.125 27.117 60.074 60.449 60.074 31.938 0 58.171-24.74 60.309-55.951L161.63 98.263a59.942 59.942 0 0 0-10.732 34.173zm256.833 151.662a68.617 68.617 0 0 1-.036-2.033c0-30.464-24.94-55.248-55.596-55.248s-55.596 24.784-55.596 55.248c0 13.556 4.862 26.316 13.78 36.393l97.448-34.36zm2.683 33.837a26.559 26.559 0 0 1-2.719-11.736v-6.183l-91.777 32.36v18.877l94.496-33.318zM497 266.522a38.29 38.29 0 0 1-10.589 5.738l-24.887 8.775v18.878l20.704-7.3c8.836-3.115 14.773-11.463 14.773-20.771v-5.32H497zm-27.979-22.582.971-.966a7.5 7.5 0 1 0-10.58-10.632l-.971.966a7.5 7.5 0 0 0 5.29 12.816 7.479 7.479 0 0 0 5.29-2.184zm-352.537 42.951c0-25.427 20.783-46.113 46.328-46.113s46.328 20.687 46.328 46.113c0 25.428-20.783 46.114-46.328 46.114s-46.328-20.687-46.328-46.114zm15 0c0 17.156 14.054 31.114 31.328 31.114s31.328-13.958 31.328-31.114-14.054-31.113-31.328-31.113c-17.274-.001-31.328 13.956-31.328 31.113zm-11.89-102.79a7.5 7.5 0 0 0-10.607-.026l-.971.966a7.5 7.5 0 0 0 5.29 12.816 7.477 7.477 0 0 0 5.29-2.184l.971-.966a7.5 7.5 0 0 0 .027-10.606zm194.212-.027-.971.966a7.5 7.5 0 1 0 10.58 10.632l.971-.966a7.5 7.5 0 0 0-10.58-10.632zM172.52 284.737a7.477 7.477 0 0 0 5.287-2.181l.971-.965a7.5 7.5 0 0 0 .032-10.606 7.5 7.5 0 0 0-10.606-.032l-.971.965a7.5 7.5 0 0 0-.032 10.606 7.472 7.472 0 0 0 5.319 2.213z"/></svg>`;

  return (
    <View style={tw`items-center justify-center`}>
      <Animated.View 
        style={[
          tw`rounded-full items-center justify-center shadow-md`,
          { 
            width: size, 
            height: size,
            backgroundColor:color,
            shadowColor:color,
            shadowOffset: { width: 0, height: 1 },
            shadowOpacity: 0.22,
            shadowRadius: 2.22,
            elevation: 3,
            opacity: opacityAnim,
            transform: [{ scale: scaleAnim }]
          }
        ]}
      >
        {renderImageBasedOnRating(rating ?? 0)}
      </Animated.View>
    </View>
  );
};

export default PizzaMarker;
